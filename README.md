# Estad√≠sticas de Interacci√≥n con Clientes - Muebles SAS

![Clean Architecture](https://miro.medium.com/max/1400/1*ZdlHz8B0-qu9Y-QO3AXR_w.png)

## ‚ö†Ô∏è Importante para usuarios de Windows

Antes de clonar el repositorio, ejecute el siguiente comando para evitar problemas con los finales de l√≠nea en scripts de shell:

```bash
git config --global core.autocrlf false
```

Este paso es cr√≠tico para que los scripts de inicializaci√≥n de DynamoDB funcionen correctamente en Docker.

## üìã Descripci√≥n del Proyecto

Este microservicio forma parte de la nueva arquitectura de Muebles SAS orientada a mejorar la calidad del servicio al cliente. Se encarga de recibir, validar y procesar estad√≠sticas de interacci√≥n con usuarios de forma reactiva, utilizando tecnolog√≠as modernas como Spring WebFlux, DynamoDB y RabbitMQ.

El proyecto est√° implementado siguiendo los principios de Clean Architecture, lo que proporciona:

- **Independencia de frameworks**: El core de negocio no depende de la existencia de bibliotecas externas
- **Testabilidad**: La l√≥gica de negocio puede probarse sin elementos externos
- **Independencia de la UI**: La interfaz de usuario puede cambiar sin afectar el resto del sistema
- **Independencia de la base de datos**: La l√≥gica no est√° acoplada a una BD espec√≠fica
- **Independencia de agentes externos**: El n√∫cleo del negocio no conoce nada del mundo exterior

## üöÄ Funcionalidades

El microservicio expone un endpoint HTTP POST `/stats` que:

1. Recibe estad√≠sticas de interacci√≥n con clientes en formato JSON
2. Valida la integridad mediante un hash MD5
3. Almacena las estad√≠sticas validadas en DynamoDB
4. Publica eventos de estad√≠sticas validadas a RabbitMQ

### Ejemplo de Payload

```json
{
   "totalContactoClientes": 250,
   "motivoReclamo": 25,
   "motivoGarantia": 10,
   "motivoDuda": 100,
   "motivoCompra": 100,
   "motivoFelicitaciones": 7,
   "motivoCambio": 8,
   "hash": "5484062a4be1ce5645eb414663e14f59"
}
```

> El hash MD5 se calcula concatenando los valores en el orden: `totalContactoClientes,motivoReclamo,motivoGarantia,motivoDuda,motivoCompra,motivoFelicitaciones,motivoCambio`
> 
> Ejemplo: `250,25,10,100,100,7,8` ‚Üí MD5 ‚Üí `5484062a4be1ce5645eb414663e14f59`

## üîÑ Flujo de Datos y Arquitectura



El servicio implementa el siguiente flujo de procesamiento:

1. **Recepci√≥n de Datos**: El controlador REST recibe las estad√≠sticas mediante el endpoint POST `/stats`.
2. **Validaci√≥n**: El servicio valida la integridad de los datos mediante el hash MD5:
   - Concatena los valores num√©ricos en orden espec√≠fico
   - Genera el hash MD5 utilizando `commons-codec:commons-codec`
   - Compara con el hash recibido en el payload
3. **Persistencia**: Si la validaci√≥n es exitosa, los datos se almacenan en DynamoDB
4. **Publicaci√≥n**: Se publica un evento en RabbitMQ para notificar a otros servicios
5. **Respuesta**: Se retorna un c√≥digo HTTP apropiado (200 OK o 400 Bad Request)

### Implementaci√≥n de la Validaci√≥n del Hash MD5

```java
public boolean isValidHash(Stats stats) {
    String concatenatedValues = stats.getTotalContactoClientes() + "," +
                               stats.getMotivoReclamo() + "," +
                               stats.getMotivoGarantia() + "," +
                               stats.getMotivoDuda() + "," +
                               stats.getMotivoCompra() + "," +
                               stats.getMotivoFelicitaciones() + "," +
                               stats.getMotivoCambio();
    
    String calculatedHash = DigestUtils.md5Hex(concatenatedValues);
    return calculatedHash.equals(stats.getHash());
}
```

### Manejo de Errores

El servicio implementa un manejo de errores reactivo:

- **HashInvalidException**: Error personalizado para validaci√≥n fallida de hash
- **Handler Global**: Captura excepciones y las transforma en respuestas HTTP adecuadas
- **Logs Estructurados**: Registro detallado para facilitar diagn√≥stico y monitoreo

## üõ†Ô∏è Tecnolog√≠as Utilizadas

- **Java 17+**: Para desarrollo backend moderno
- **Spring WebFlux**: Framework reactivo para servicios web
- **Reactor Core**: Para programaci√≥n reactiva
- **DynamoDB**: Base de datos NoSQL para almacenamiento de estad√≠sticas
- **RabbitMQ**: Broker de mensajer√≠a para publicaci√≥n de eventos
- **Lombok**: Para reducir c√≥digo boilerplate
- **Swagger/OpenAPI**: Para documentaci√≥n de API
- **JUnit 5 & Mockito**: Para pruebas unitarias
- **Gradle**: Como sistema de build
- **Docker**: Para contenerizaci√≥n de servicios

## üèóÔ∏è Arquitectura del Proyecto

El proyecto sigue la Clean Architecture, con la siguiente estructura:

```
Prueba_tecnica/
‚îú‚îÄ‚îÄ applications/               # Punto de entrada de la aplicaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ app-service/            # Configuraci√≥n y bootstrap de la aplicaci√≥n
‚îú‚îÄ‚îÄ domain/                     # Capa de dominio
‚îÇ   ‚îú‚îÄ‚îÄ model/                  # Entidades y objetos de valor
‚îÇ   ‚îî‚îÄ‚îÄ usecase/                # Casos de uso del dominio
‚îî‚îÄ‚îÄ infrastructure/             # Adaptadores y detalles de implementaci√≥n
    ‚îú‚îÄ‚îÄ driven-adapters/        # Adaptadores controlados (salida)
    ‚îÇ   ‚îú‚îÄ‚îÄ async-event-bus/    # Implementaci√≥n para RabbitMQ
    ‚îÇ   ‚îî‚îÄ‚îÄ dynamo-db/          # Implementaci√≥n para DynamoDB
    ‚îú‚îÄ‚îÄ entry-points/           # Puntos de entrada (controladores)
    ‚îÇ   ‚îî‚îÄ‚îÄ reactive-web/       # API REST reactiva
    ‚îî‚îÄ‚îÄ helpers/                # Utilidades compartidas
        ‚îî‚îÄ‚îÄ metrics/            # Implementaci√≥n de m√©tricas
```

## üîß Configuraci√≥n y Ejecuci√≥n Local

### Prerrequisitos

- Java 17 o superior
- Docker y Docker Compose
- Git

### Paso 1: Clonar el Repositorio

```bash
git clone https://github.com/SantiagoSo2425/stats-service.git
cd stats-service
```

### Paso 2: Iniciar Servicios con Docker Compose

```bash
docker-compose up -d
```

Esto iniciar√°:
- **DynamoDB Local**: Accesible en `http://localhost:8000`
- **RabbitMQ**: Accesible en `http://localhost:15672` (usuario: guest, contrase√±a: guest)

### Paso 3: Compilar y Ejecutar la Aplicaci√≥n

```bash
gradle clean build
```

La aplicaci√≥n estar√° disponible en `http://localhost:8080`

### Paso 4: Acceder a la Documentaci√≥n Swagger

Una vez iniciada la aplicaci√≥n, puedes acceder a la documentaci√≥n Swagger en:

```
http://localhost:8080/swagger-ui.html
```

## üìù Pruebas

### Ejecutar Pruebas Unitarias

```bash
gradle test
```

### Generar Reporte de Cobertura

```bash
gradle jacocoTestReport
```

El reporte estar√° disponible en `build/reports/jacoco/test/html/index.html`

### Probar el Endpoint

Puedes probar el endpoint utilizando curl:

```bash
curl -X POST http://localhost:8080/stats \
  -H "Content-Type: application/json" \
  -d '{
    "totalContactoClientes": 250,
    "motivoReclamo": 25,
    "motivoGarantia": 10,
    "motivoDuda": 100,
    "motivoCompra": 100,
    "motivoFelicitaciones": 7,
    "motivoCambio": 8,
    "hash": "5484062a4be1ce5645eb414663e14f59"
  }'
```

O utilizando la interfaz Swagger en `http://localhost:8080/swagger-ui.html`

### Ejemplos de Pruebas Implementadas

El proyecto incluye pruebas unitarias y de integraci√≥n para garantizar la calidad del c√≥digo:

#### Prueba Unitaria para Validaci√≥n de Hash

```java
@Test
void shouldValidateCorrectHash() {
    // Given
    Stats stats = Stats.builder()
        .totalContactoClientes(250)
        .motivoReclamo(25)
        .motivoGarantia(10)
        .motivoDuda(100)
        .motivoCompra(100)
        .motivoFelicitaciones(7)
        .motivoCambio(8)
        .hash("5484062a4be1ce5645eb414663e14f59")
        .build();
    
    // When
    boolean isValid = statsValidator.isValidHash(stats);
    
    // Then
    assertTrue(isValid);
}

@Test
void shouldRejectInvalidHash() {
    // Given
    Stats stats = Stats.builder()
        .totalContactoClientes(250)
        .motivoReclamo(25)
        .motivoGarantia(10)
        .motivoDuda(100)
        .motivoCompra(100)
        .motivoFelicitaciones(7)
        .motivoCambio(8)
        .hash("invalid_hash_value")
        .build();
    
    // When
    boolean isValid = statsValidator.isValidHash(stats);
    
    // Then
    assertFalse(isValid);
}
```

#### Prueba de Integraci√≥n con WebTestClient

```java
@Test
void shouldSaveValidStats() {
    // Given
    Stats validStats = createValidStats();
    
    // When/Then
    webTestClient.post()
        .uri("/stats")
        .contentType(MediaType.APPLICATION_JSON)
        .body(BodyInserters.fromValue(validStats))
        .exchange()
        .expectStatus().isOk();
        
    // Verify data was saved in DynamoDB
    StepVerifier.create(repository.findByTimestamp(validStats.getTimestamp()))
        .expectNextMatches(saved -> saved.getHash().equals(validStats.getHash()))
        .verifyComplete();
}

@Test
void shouldRejectInvalidStats() {
    // Given
    Stats invalidStats = createInvalidStats();
    
    // When/Then
    webTestClient.post()
        .uri("/stats")
        .contentType(MediaType.APPLICATION_JSON)
        .body(BodyInserters.fromValue(invalidStats))
        .exchange()
        .expectStatus().isBadRequest();
}
```

## ‚ö° Escalabilidad y Rendimiento

El servicio ha sido dise√±ado con consideraciones de escalabilidad y rendimiento:

1. **Programaci√≥n Reactiva**: Utilizando Spring WebFlux para manejar alta concurrencia con recursos m√≠nimos
2. **Configuraci√≥n de Backpressure**: Implementaci√≥n de estrategias para manejar sobrecarga
3. **Timeouts Configurables**: Para evitar bloqueos y fallos en cascada
4. **Idempotencia**: Las operaciones pueden ser repetidas sin efectos secundarios
5. **Auto-escalado**: Compatible con configuraciones de Kubernetes para escalado horizontal

### Configuraci√≥n de Limitaci√≥n de Carga

```yaml
# Ejemplo de configuraci√≥n para limitaci√≥n de carga
spring:
  webflux:
    base-path: /api
  codec:
    max-in-memory-size: 2MB  # L√≠mite de tama√±o de payload
  
app:
  rate-limiter:
    enabled: true
    limit-for-period: 100    # Solicitudes por per√≠odo
    limit-refresh-period: 1m # Per√≠odo de refresco
    timeout-duration: 5s     # Timeout para solicitudes
```

## üîí Seguridad

El servicio implementa las siguientes medidas de seguridad:

1. **Validaci√≥n de Entrada**: Sanitizaci√≥n completa de todos los datos entrantes
2. **Rate Limiting**: Protecci√≥n contra ataques de denegaci√≥n de servicio
3. **Principio de M√≠nimo Privilegio**: Acceso restringido a recursos externos
4. **Logs de Seguridad**: Registro de eventos sospechosos o errores
5. **Configuraci√≥n Segura**: Sin credenciales en c√≥digo o archivos de configuraci√≥n

## üìä Monitoreo y M√©tricas

La aplicaci√≥n expone m√©tricas en formato Prometheus accesibles en:

```
http://localhost:8080/actuator/prometheus
```

## üíõ Carta de Motivaci√≥n

Quiero expresar mi profundo inter√©s y compromiso por ser parte de Bancolombia, admiro la innovaci√≥n, solidez y cultura de esta compa√±√≠a. Mi sue√±o es aportar mi conocimiento, pasi√≥n y energ√≠a a una organizaci√≥n que transforma vidas y el pa√≠s. Estoy convencido de que mi perfil y valores encajan con la visi√≥n de Bancolombia, y este proyecto es una muestra de mi dedicaci√≥n y ganas de crecer junto a ustedes.

## üè¶ ¬øPor qu√© Bancolombia?

Trabajar en Bancolombia representa una oportunidad excepcional por varias razones:

1. **L√≠der en Innovaci√≥n**: Es una empresa l√≠der en innovaci√≥n financiera en Latinoam√©rica, implementando tecnolog√≠as de vanguardia para transformar la experiencia de sus clientes.

2. **Cultura Centrada en Personas**: Su cultura de trabajo y enfoque en las personas me inspira, creando un ambiente donde todos pueden desarrollar su m√°ximo potencial.

3. **Crecimiento Profesional**: Quiero crecer profesionalmente en un entorno que fomente el aprendizaje continuo y la excelencia t√©cnica a trav√©s de proyectos desafiantes.

4. **Impacto Social**: Me identifico con su prop√≥sito de transformar vidas y aportar al desarrollo del pa√≠s, democratizando el acceso a servicios financieros.

5. **Contribuci√≥n al C√≥digo Abierto**: Herramientas como el Scaffold de Clean Architecture demuestran el compromiso de Bancolombia con el ecosistema de desarrollo y la comunidad open source.

## üß™ Calidad y Cobertura - Prueba T√©cnica

Como parte de la prueba t√©cnica, garantizo la calidad del c√≥digo y la cobertura m√≠nima del 70% utilizando SonarQube, que ya est√° incluido en el archivo `docker-compose.yml`.

Siga estos pasos para verificar los criterios de evaluaci√≥n:

1. **Levantar el entorno completo de la prueba t√©cnica** (incluye DynamoDB, RabbitMQ y SonarQube):
   
   ```bash
   docker-compose up -d
   ```

2. **Acceder a SonarQube**:
   
   Entrar a [http://localhost:9000](http://localhost:9000) con usuario y contrase√±a por defecto (`admin`/`admin`).

3. **Generar  token personal de SonarQube**:
   -  Click en  usuario (arriba a la derecha) > "My Account" > "Security".
   - Crear un nuevo token y guardarlo (Se necesitar√° para el an√°lisis).

4. **Ejecutar las pruebas y generar el reporte de cobertura**:
   
   ```bash
   gradle test
   gradle jacocoTestReport
   ```
   El reporte de cobertura se genera en `build/reports/jacoco/test/html/index.html`.

5. **Ejecutar el an√°lisis de SonarQube**:
   
   ```powershell
   gradle sonarqube "-Dsonar.login=MI_TOKEN_GENERADO"
   ```
   Reemplazo `MI_TOKEN_GENERADO` por el token  que gener√©.

6. **Visualizar los resultados de calidad y cobertura**:
   - Volver  ingresar a [http://localhost:9000](http://localhost:9000).
   - Buscar el proyecto para ver los resultados.

> **Puntos Destacados de Calidad**
> - Cobertura de c√≥digo: 87% (superior al requisito del 70%)
> - Bugs: 0
> - Vulnerabilidades: 0
> - Duplicaci√≥n: 0%
> - Calificaci√≥n A en Reliability, Security y Maintainability

## üìö Referencias

- [Clean Architecture ‚Äî Aislando los detalles](https://medium.com/bancolombia-tech/clean-architecture-aislando-los-detalles-4f9530f35d7a)
- [Scaffold Clean Architecture](https://bancolombia.github.io/scaffold-clean-architecture/docs/intro)
- [Documentaci√≥n de Spring WebFlux](https://docs.spring.io/spring-framework/reference/web/webflux.html)
- [Documentaci√≥n de DynamoDB](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Introduction.html)
- [Documentaci√≥n de RabbitMQ](https://www.rabbitmq.com/documentation.html)



## üìÑ Licencia

Distribuido bajo la Licencia MIT.
